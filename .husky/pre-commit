#!/bin/sh
# pre-commit: regenerate README and stage it for the commit (skip if commit is only README.md)

# Determine staged files (Added/Copied/Modified)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# If only README.md is staged, skip generator to avoid loops
OTHER_FILES=$(echo "$STAGED_FILES" | grep -v '^README.md$' || true)
if [ -z "$OTHER_FILES" ]; then
  echo "[husky] commit only contains README.md — skipping README regeneration."
  exit 0
fi

# Run the README generator (don't fail the commit if generator errors)
echo "[husky] running README generator..."
if ! npx --no-install ts-node --transpile-only ./scripts/generate-readme.ts 2>/dev/null; then
  # fall back to network-installed ts-node via npx when local not available
  if ! npx ts-node --transpile-only ./scripts/generate-readme.ts; then
    echo "[husky] README generator failed — continuing without blocking commit."
    exit 0
  fi
fi

# If README.md changed, add it to the index so the current commit includes it
if git diff --quiet -- README.md; then
  echo "[husky] README.md unchanged."
else
  git add README.md
  echo "[husky] README.md regenerated and staged for commit."
fi

exit 0
